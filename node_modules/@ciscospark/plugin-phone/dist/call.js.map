{"version":3,"sources":["../src/call.js"],"names":["Call","extend","namespace","children","media","session","correlationId","facingMode","type","values","locus","localMediaStream","localMediaStreamUrl","remoteMediaStreamUrl","derived","id","deps","fn","url","isActive","activeParticipants","activeParticipantsCount","length","joined","default","joinedOnThisDevice","spark","locusUrl","device","self","devices","item","mediaConnection","mediaConnections","mediaId","remoteAudioMuted","remote","remoteVideoMuted","direction","from","local","to","status","state","remoteMediaStream","receivingAudio","receivingVideo","sendingAudio","sendingVideo","initialize","args","prototype","listenTo","mercury","event","_onLocusEvent","error","trigger","on","stopListening","off","URL","revokeObjectURL","undefined","createOffer","then","offer","updateMedia","sdp","_fetchExpectedLocus","_setLocus","JSON","parse","remoteSdp","acceptAnswer","catch","reason","emit","createObjectURL","unset","mode","forEach","key","logger","info","hangup","previousLocus","previousAttributes","answer","options","resolve","peer","_join","acknowledge","alert","dial","invitee","validate","parsed","decode","split","resourceType","phone","register","reject","end","locusJoinInFlight","when","_hangup","locusLeaveInFlight","leave","decline","toggleFacingMode","constraints","audio","audioConstraint","video","videoConstraint","Error","exact","createLocalMediaStream","stream","once","startSendingAudio","_changeSendingMedia","startSendingVideo","startReceivingAudio","_changeReceivingMedia","startReceivingVideo","toggleReceivingAudio","stopReceivingAudio","toggleReceivingVideo","stopReceivingVideo","toggleSendingAudio","stopSendingAudio","toggleSendingVideo","stopSendingVideo","sendFeedback","feedback","metrics","submit","value","_updateSendingMedia","set","localDescription","audioMuted","videoMuted","get","locusMethodName","target","defaultFacingMode","recvOnly","offerOptions","offerToReceiveAudio","offerToReceiveVideo","v4","localSdp","data","eventType","incoming","current","action","compare","locusAudio","audioStatus","toLowerCase","mediaAudio","warn","locusVideo","videoStatus","mediaVideo","make","attrs"],"mappings":"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","file":"call.js","sourcesContent":["/**!\n *\n * Copyright (c) 2016-2017 Cisco Systems, Inc. See LICENSE file.\n * @private\n */\n\n/* eslint-env browser: true */\n/* global RTCPeerConnection, RTCSessionDescription */\n\nimport {SparkPlugin} from '@ciscospark/spark-core';\nimport {base64, oneFlight, retry, tap} from '@ciscospark/common';\nimport {\n  USE_INCOMING,\n  FETCH\n} from '@ciscospark/plugin-locus';\nimport {debounce, defaults, find, get, set} from 'lodash';\nimport {\n  activeParticipants,\n  direction,\n  isActive,\n  joined,\n  joinedOnThisDevice,\n  participantIsJoined,\n  remoteAudioMuted,\n  remoteParticipant,\n  remoteVideoMuted\n} from './state-parsers';\nimport boolToStatus from './bool-to-status';\n\nimport WebRTCMedia from './web-rtc-media';\nimport uuid from 'uuid';\n\n/**\n * @event ringing\n * @instance\n * @memberof Call\n */\n\n/**\n * @event connected\n * @instance\n * @memberof Call\n */\n\n/**\n * @event disconnected\n * @instance\n * @memberof Call\n */\n\n/**\n * @event localMediaStream:change\n * @instance\n * @memberof Call\n */\n\n/**\n * @event remoteMediaStream:change\n * @instance\n * @memberof Call\n */\n\n/**\n * @event error\n * @instance\n * @memberof Call\n */\n\n/**\n * Payload for {@link Call#sendFeedback}\n * @typedef {Object} Types~Feedback\n * @property {number} userRating Number between 1 and 5 (5 being best) to let\n * the user score the call\n * @property {string} userComments Freeform feedback from the user about the\n * call\n * @property {Boolean} includeLogs set to true to submit client logs to the\n * Cisco Spark cloud. Note: at this time, all logs, not just call logs,\n * generated by the sdk will be uploaded to the Spark Cloud. Care has been taken\n * to avoid including PII in these logs, but if you've taken advantage of the\n * SDK's logger, you should make sure to avoid logging PII as well.\n */\n\n/**\n * @class\n * @extends SparkPlugin\n */\nconst Call = SparkPlugin.extend({\n  namespace: `Phone`,\n\n  children: {\n    media: WebRTCMedia\n  },\n\n  session: {\n    correlationId: `string`,\n    /**\n     * @instance\n     * @memberof Call\n     * @type {string}\n     * @readonly\n     */\n    facingMode: {\n      type: `string`,\n      values: [`user`, `environment`]\n    },\n    locus: `object`,\n    /**\n     * Returns the local MediaStream for the call. May initially be `null`\n     * between the time @{Phone#dial is invoked and the  media stream is\n     * acquired if {@link Phone#dial} is invoked without a `localMediaStream`\n     * option.\n     *\n     * This property can also be set mid-call in which case the streams sent to\n     * the remote party are replaced by this stream. On success, the\n     * {@link Call}'s {@link localMediaStream:change} event fires, notifying any\n     * listeners that we are now sending media from a new source.\n     * @instance\n     * @memberof Call\n     * @type {MediaStream}\n     */\n    localMediaStream: `object`,\n    /**\n     * Object URL that refers to {@link Call#localMediaStream}. Will be\n     * automatically deallocated when the call ends\n     * @instance\n     * @memberof Call\n     * @type {string}\n     * @readonly\n     */\n    localMediaStreamUrl: `string`,\n    /**\n     * Object URL that refers to {@link Call#remoteMediaStream}. Will be\n     * automatically deallocated when the call ends\n     * @instance\n     * @memberof Call\n     * @type {string}\n     * @readonly\n     */\n    remoteMediaStreamUrl: `string`\n  },\n\n  // Note, in its current form, any derived property that is an object will emit\n  // a change event everytime a locus gets replaced, even if no values change.\n  // For the moment, this is probably ok; once we have multi-party, regular\n  // change events on activeParticipants may be a problem.\n  derived: {\n    id: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && this.locus.url;\n      }\n    },\n    isActive: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && isActive(this.locus);\n      }\n    },\n    activeParticipants: {\n      deps: [`locus`],\n      fn() {\n        return activeParticipants(this.locus);\n      }\n    },\n    activeParticipantsCount: {\n      deps: [`activeParticipants`],\n      fn() {\n        return this.activeParticipants.length;\n      }\n    },\n    joined: {\n      deps: [`locus`],\n      default: false,\n      fn() {\n        return this.locus && joined(this.locus);\n      }\n    },\n    joinedOnThisDevice: {\n      deps: [`locus`],\n      default: false,\n      fn() {\n        return this.locus && joinedOnThisDevice(this.spark, this.locus);\n      }\n    },\n    locusUrl: {\n      deps: [`locus`],\n      fn() {\n        return this.locus.url;\n      }\n    },\n    device: {\n      deps: [`locus`],\n      fn() {\n        return this.locus.self && find(this.locus.self.devices, (item) => item.url === this.spark.device.url);\n      }\n    },\n    mediaConnection: {\n      deps: [`device`],\n      fn() {\n        return this.device && this.device.mediaConnections && this.device.mediaConnections[0];\n      }\n    },\n    mediaId: {\n      deps: [`mediaConnection`],\n      fn() {\n        return this.mediaConnection && this.mediaConnection.mediaId;\n      }\n    },\n    remoteAudioMuted: {\n      deps: [`remote`],\n      fn() {\n        return remoteAudioMuted(this.remote);\n      }\n    },\n    remoteVideoMuted: {\n      deps: [`remote`],\n      fn() {\n        return remoteVideoMuted(this.remote);\n      }\n    },\n    direction: {\n      deps: [`locus`],\n      fn() {\n        // This seems brittle, but I can't come up with a better way. The only\n        // way we should have a Call without a locus is if we just initiated a\n        // call but haven't got the response from locus yet.\n        if (!this.locus) {\n          return `out`;\n        }\n        return direction(this.locus);\n      }\n    },\n    from: {\n      deps: [\n        `direction`,\n        `local`,\n        `remote`\n      ],\n      fn() {\n        return this.direction === `out` ? this.local : this.remote;\n      }\n    },\n    to: {\n      deps: [\n        `direction`,\n        `local`,\n        `remote`\n      ],\n      fn() {\n        return this.direction === `in` ? this.local : this.remote;\n      }\n    },\n    local: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && this.locus.self;\n      }\n    },\n    remote: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && remoteParticipant(this.locus);\n      }\n    },\n    /**\n     * <b>initiated</b> - Offer was sent to remote party but they have not yet accepted <br>\n     * <b>ringing</b> - Remote party has acknowledged the call <br>\n     * <b>connected</b> - At least one party is still on the call <br>\n     * <b>disconnected</b> - All parties have dropped <br>\n     * @instance\n     * @memberof Call\n     * @member {string}\n     * @readonly\n     */\n    status: {\n      deps: [\n        `joinedOnThisDevice`,\n        `local`,\n        `remote`\n      ],\n      fn() {\n        if (this.joinedOnThisDevice && this.remote && participantIsJoined(this.remote)) {\n          return `connected`;\n        }\n\n        if (this.remote && this.local) {\n          if (this.remote.state === `LEFT` || this.local.state === `LEFT`) {\n            return `disconnected`;\n          }\n\n          if (this.remote.state === `DECLINED`) {\n            return `disconnected`;\n          }\n\n          if (this.remote.state === `NOTIFIED`) {\n            return `ringing`;\n          }\n        }\n\n        return `initiated`;\n      }\n    },\n    /**\n     * Access to the remote partyâ€™s `MediaStream`.\n     * @instance\n     * @memberof Call\n     * @member {MediaStream}\n     * @readonly\n     */\n    remoteMediaStream: {\n      deps: [`media.remoteMediaStream`],\n      fn() {\n        return this.media.remoteMediaStream;\n      }\n    },\n    receivingAudio: {\n      deps: [`media.receivingAudio`],\n      fn() {\n        return this.media.receivingAudio;\n      }\n    },\n    receivingVideo: {\n      deps: [`media.receivingVideo`],\n      fn() {\n        return this.media.receivingVideo;\n      }\n    },\n    sendingAudio: {\n      deps: [`media.sendingAudio`],\n      fn() {\n        return this.media.sendingAudio;\n      }\n    },\n    sendingVideo: {\n      deps: [`media.sendingVideo`],\n      fn() {\n        return this.media.sendingVideo;\n      }\n    }\n  },\n\n  /**\n   * Initializer\n   * @private\n   * @param {Object} attrs\n   * @param {Object} options\n   * @returns {undefined}\n   */\n  initialize(...args) {\n    Reflect.apply(SparkPlugin.prototype.initialize, this, args);\n\n    this.listenTo(this.spark.mercury, `event:locus`, (event) => this._onLocusEvent(event));\n    this.listenTo(this.media, `error`, (error) => this.trigger(`error`, error));\n    this.on(`disconnected`, () => {\n      this.stopListening(this.spark.mercury);\n      this.off();\n      URL.revokeObjectURL(this.localMediaStreamUrl);\n      this.localMediaStreamUrl = undefined;\n      URL.revokeObjectURL(this.remoteMediaStreamUrl);\n      this.remoteMediaStreamUrl = undefined;\n    });\n\n    this.listenTo(this.media, `negotiationneeded`, debounce(() => {\n      this.media.createOffer()\n        .then((offer) => this.spark.locus.updateMedia(this.locus, {\n          sdp: offer,\n          mediaId: this.mediaId\n        }))\n        .then(() => this._fetchExpectedLocus())\n        .then((locus) => {\n          this._setLocus(locus);\n          const sdp = JSON.parse(this.mediaConnection.remoteSdp).sdp;\n          return this.media.acceptAnswer(sdp);\n        })\n        .catch((reason) => this.emit(`error`, reason));\n    }));\n\n    this.on(`change:remoteMediaStream`, () => {\n      if (this.remoteMediaStreamUrl) {\n        URL.revokeObjectURL(this.remoteMediaStreamUrl);\n      }\n      if (this.remoteMediaStream) {\n        this.remoteMediaStreamUrl = URL.createObjectURL(this.remoteMediaStream);\n      }\n      else {\n        this.unset(`remoteMediaStreamUrl`);\n      }\n    });\n\n    // Reminder: this is not a derived property so that we can reassign the\n    // stream midcall\n    this.on(`change:media.localMediaStream`, () => {\n      this.localMediaStream = this.media.localMediaStream;\n      if (this.localMediaStreamUrl) {\n        URL.revokeObjectURL(this.localMediaStreamUrl);\n      }\n      if (this.localMediaStream) {\n        this.localMediaStreamUrl = URL.createObjectURL(this.localMediaStream);\n      }\n      else {\n        this.unset(`localMediaStreamUrl`);\n      }\n    });\n\n    this.on(`change:localMediaStream`, () => {\n      if (this.media.localMediaStream !== this.localMediaStream) {\n        this.media.localMediaStream = this.localMediaStream;\n      }\n\n\n      if (this.facingMode) {\n        const mode = get(this, `media.videoConstraint.facingMode.exact`);\n        if (mode === `user`) {\n          this.facingMode = `user`;\n        }\n\n        if (mode === `environment`) {\n          this.facingMode = `environment`;\n        }\n      }\n    });\n\n    [\n      `remoteMediaStream`,\n      `remoteMediaStreamUrl`,\n      `localMediaStream`,\n      `localMediaStreamUrl`,\n      `remoteAudioMuted`,\n      `remoteVideoMuted`\n    ].forEach((key) => {\n      this.on(`change:${key}`, () => this.trigger(`${key}:change`));\n    });\n\n    // This handler is untested because there's no way to provoke it. It's\n    // probably actually only relevant for group calls.\n    this.on(`change:isActive`, () => {\n      if (!this.isActive) {\n        if (this.joinedOnThisDevice) {\n          this.logger.info(`call: hanging up due to locus going inactive`);\n          this.hangup();\n        }\n      }\n    });\n\n    this.on(`change:activeParticipantsCount`, () => {\n      const previousLocus = this.previousAttributes().locus;\n      if (this.joinedOnThisDevice && this.activeParticipantsCount === 1 && previousLocus && activeParticipants(previousLocus).length > 1) {\n        this.logger.info(`call: hanging up due to last participant in call`);\n        this.hangup();\n      }\n    });\n\n    this.on(`change:status`, () => {\n      switch (this.status) {\n      case `ringing`:\n        this.trigger(`ringing`);\n        break;\n      case `connected`:\n        this.trigger(`connected`);\n        break;\n      case `disconnected`:\n        this.trigger(`disconnected`);\n        break;\n      default:\n        // do nothing\n      }\n    });\n  },\n\n  /**\n   * Answers an incoming call. Only applies to incoming calls. Invoking this\n   * method on an outgoing call is a noop\n   * @instance\n   * @memberof Call\n   * @param {Object} options\n   * @param {MediaStreamConstraints} options.constraints\n   * @returns {Promise}\n   */\n  @oneFlight\n  answer(options) {\n    this.logger.info(`call: answering`);\n    if (!this.locus || this.direction === `out`) {\n      return Promise.resolve();\n    }\n    // Locus may think we're joined on this device if we e.g. reload the page,\n    // so, we need to check if we also have a working peer connection\n    if (this.joinedOnThisDevice && this.media.peer) {\n      this.logger.info(`call: already joined on this device`);\n      return Promise.resolve();\n    }\n    return this._join(`join`, this.locus, options)\n      .then(tap(() => this.logger.info(`call: answered`)));\n  },\n\n  /**\n   * Use to acknowledge (without answering) an incoming call. Will cause the\n   * initiator's Call instance to emit the ringing event.\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  @oneFlight\n  acknowledge() {\n    this.logger.info(`call: acknowledging`);\n    return this.spark.locus.alert(this.locus)\n      .then((locus) => this._setLocus(locus))\n      .then(tap(() => this.logger.info(`call: acknowledged`)));\n  },\n\n  /**\n   * Used by {@link Phone#dial} to initiate an outbound call\n   * @instance\n   * @memberof Call\n   * @param {[type]} invitee\n   * @param {[type]} options\n   * @private\n   * @returns {[type]}\n   */\n  @oneFlight\n  dial(invitee, options) {\n    this.logger.info(`call: dialing`);\n\n    if (base64.validate(invitee)) {\n      // eslint-disable-next-line no-unused-vars\n      const parsed = base64.decode(invitee).split(`/`);\n      const resourceType = parsed[3];\n      const id = parsed[4];\n      if (resourceType === `PEOPLE`) {\n        invitee = id;\n      }\n    }\n\n    this.spark.phone.register()\n      .then(() => this._join(`create`, invitee, options))\n      .then(tap(() => this.logger.info(`call: dialed`)))\n      .catch((reason) => {\n        this.trigger(`error`, reason);\n      });\n\n    return this;\n  },\n\n  /**\n   * Disconnects the active call. Applies to both incoming and outgoing calls.\n   * This method may be invoked in any call state and the SDK should take care\n   * to tear down the call and free up all resources regardless of the state.\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  hangup() {\n    // Note: not a @oneFlight because this function must call itself\n    if (this.direction === `in` && !this.joinedOnThisDevice) {\n      return this.reject();\n    }\n\n    this.logger.info(`call: hanging up`);\n\n    this.media.end();\n\n    if (!this.locus) {\n      if (this.locusJoinInFlight) {\n        this.logger.info(`call: no locus, waiting for rest call to complete before hanging up`);\n        return this.when(`change:locus`)\n          .then(() => this.hangup());\n      }\n\n      this.stopListening(this.spark.mercury);\n      this.off();\n      this.logger.info(`call: hang up complete, call never created`);\n      return Promise.resolve();\n    }\n\n    return this._hangup();\n  },\n\n  /**\n   * Does the internal work necessary to end a call while allowing hangup() to\n   * call itself without getting stuck in promise change because of oneFlight\n   * @private\n   * @returns {Promise}\n   */\n  @oneFlight\n  _hangup() {\n    this.locusLeaveInFlight = true;\n    return this.spark.locus.leave(this.locus)\n      .then((locus) => this._setLocus(locus))\n      .then(() => {\n        this.locusLeaveInFlight = false;\n      })\n      .then(tap(() => this.stopListening(this.spark.mercury)))\n      .then(tap(() => this.off()))\n      .then(tap(() => this.logger.info(`call: hung up`)));\n  },\n\n  /**\n   * Alias of {@link Call#reject}\n   * @see {@link Call#reject}\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  decline() {\n    return this.reject();\n  },\n\n  /**\n   * Rejects an incoming call. Only applies to incoming calls. Invoking this\n   * method on an outgoing call is a no-op.\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  @oneFlight\n  reject() {\n    if (this.direction === `out`) {\n      return Promise.resolve();\n    }\n\n    this.logger.info(`call: rejecting`);\n    /* eslint no-invalid-this: [0] */\n    return this.spark.locus.decline(this.locus)\n      .then((locus) => this._setLocus(locus))\n      .then(tap(() => this.stopListening(this.spark.mercury)))\n      .then(tap(() => this.off()))\n      .then(tap(() => this.logger.info(`call: rejected`)));\n  },\n\n  /**\n   * Replaces the current mediaStrem with one with identical constraints, except\n   * for an opposite facing mode. If the current facing mode cannot be\n   * determined, the facing mode will be set to `user`. If the call is audio\n   * only, this function will throw.\n   * @returns {undefined}\n   */\n  toggleFacingMode() {\n    const constraints = {\n      audio: Object.assign({}, this.media.audioConstraint),\n      video: this.media.videoConstraint\n    };\n\n    if (!constraints.video) {\n      throw new Error(`Cannot toggle facignMode on audio-only call`);\n    }\n\n    if (this.facingMode !== `user` && this.facingMode !== `environment`) {\n      throw new Error(`Cannot determine current facing mode; specify a new localMediaStream to change cameras`);\n    }\n\n    if (constraints.video === true) {\n      constraints.video = {\n        facingMode: {\n          exact: this.facingMode\n        }\n      };\n    }\n\n    if (this.facingMode === `user`) {\n      set(constraints, `video.facingMode.exact`, `environment`);\n    }\n    else {\n      set(constraints, `video.facingMode.exact`, `user`);\n    }\n\n    return this.spark.phone.createLocalMediaStream(constraints)\n      .then((stream) => new Promise((resolve) => {\n        this.media.once(`answeraccepted`, resolve);\n        this.localMediaStream = stream;\n      }))\n      .then(() => {\n        this.facingMode = constraints.video.facingMode.exact;\n      });\n  },\n\n  /**\n   * Starts sending audio to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  startSendingAudio() {\n    return this._changeSendingMedia(`audio`, true);\n  },\n\n  /**\n   * Starts sending video to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  startSendingVideo() {\n    return this._changeSendingMedia(`video`, true);\n  },\n\n  startReceivingAudio() {\n    return this._changeReceivingMedia(`offerToReceiveAudio`, true);\n  },\n\n  startReceivingVideo() {\n    return this._changeReceivingMedia(`offerToReceiveVideo`, true);\n  },\n\n  /**\n   * Toggles receiving audio from the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleReceivingAudio() {\n    return this.receivingAudio ? this.stopReceivingAudio() : this.startReceivingAudio();\n  },\n\n  /**\n   * Toggles receiving video from the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleReceivingVideo() {\n    return this.receivingVideo ? this.stopReceivingVideo() : this.startReceivingVideo();\n  },\n\n  stopReceivingAudio() {\n    return this._changeReceivingMedia(`offerToReceiveAudio`, false);\n  },\n\n  stopReceivingVideo() {\n    return this._changeReceivingMedia(`offerToReceiveVideo`, false);\n  },\n\n  /**\n   * Toggles sending audio to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleSendingAudio() {\n    return this.sendingAudio ? this.stopSendingAudio() : this.startSendingAudio();\n  },\n\n  /**\n   * Toggles sending video to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleSendingVideo() {\n    return this.sendingVideo ? this.stopSendingVideo() : this.startSendingVideo();\n  },\n\n  /**\n   * Sends feedback about the call to the Cisco Spark cloud\n   * @instance\n   * @memberof Call\n   * @param {Types~Feedback} feedback\n   * @returns {Promise}\n   */\n  sendFeedback(feedback) {\n    return this.spark.metrics.submit(`meetup_call_user_rating`, feedback);\n  },\n\n  /**\n   * Stops sending audio to the Cisco Spark Cloud. (stops broadcast immediately,\n   * even if renegotiation has not completed)\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  stopSendingAudio() {\n    return this._changeSendingMedia(`audio`, false);\n  },\n\n  /**\n   * Stops sending video to the Cisco Spark Cloud. (stops broadcast immediately,\n   * even if renegotiation has not completed)\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  stopSendingVideo() {\n    return this._changeSendingMedia(`video`, false);\n  },\n\n  _changeSendingMedia(key, value) {\n    return new Promise((resolve) => {\n      this.once(`change:sending${key === `audio` ? `Audio` : `Video`}`, () => resolve(this._updateSendingMedia()));\n      this.media.set(key, value);\n    });\n  },\n\n  @oneFlight\n  _updateSendingMedia() {\n    // This method should never send a new sdp; if we performed an action that\n    // would cause a new sdp, the onnegotiationneeded handler should exchange\n    // it. this means that for a number of scenarios, we must call update media\n    // twice.\n    return this.spark.locus.updateMedia(this.locus, {\n      sdp: this.media.peer.localDescription.sdp,\n      mediaId: this.mediaId,\n      audioMuted: !this.sendingAudio,\n      videoMuted: !this.sendingVideo\n    })\n    .then(() => this.spark.locus.get(this.locus))\n    .then((locus) => this._setLocus(locus));\n  },\n\n  // The complexity in _join is largely driven up by fairly readable `||`s\n  @oneFlight\n  // eslint-disable-next-line complexity\n  _join(locusMethodName, target, options = {}) {\n    if (options.localMediaStream) {\n      this.media.set(`localMediaStream`, options.localMediaStream);\n    }\n    else {\n      if (!options.constraints) {\n        options.constraints = {\n          audio: true,\n          video: {\n            facingMode: {\n              exact: this.spark.phone.defaultFacingMode\n            }\n          }\n        };\n      }\n      const mode = get(options, `constraints.video.facingMode.exact`);\n      if (mode === `user` || mode === `environment`) {\n        this.facingMode = mode;\n      }\n\n      const recvOnly = !options.constraints.audio && !options.constraints.video;\n      options.offerOptions = defaults(options.offerOptions, {\n        offerToReceiveAudio: recvOnly || !!options.constraints.audio,\n        offerToReceiveVideo: recvOnly || !!options.constraints.video\n      });\n\n      this.media.set({\n        audio: options.constraints.audio,\n        video: options.constraints.video,\n        offerToReceiveAudio: options.offerOptions.offerToReceiveAudio,\n        offerToReceiveVideo: options.offerOptions.offerToReceiveVideo\n      });\n    }\n\n    if (!target.correlationId) {\n      this.correlationId = options.correlationId = uuid.v4();\n    }\n\n    if (!this.correlationId) {\n      this.correlationId = target.correlationId;\n    }\n\n    return this.media.createOffer()\n      .then((offer) => this.spark.locus[locusMethodName](target, {\n        localSdp: offer,\n        correlationId: this.correlationId\n      }))\n      .then((locus) => {\n        this._setLocus(locus);\n        this.locusJoinInFlight = false;\n        const answer = JSON.parse(this.mediaConnection.remoteSdp).sdp;\n        return this.media.acceptAnswer(answer);\n      });\n  },\n\n  _onLocusEvent(event) {\n    const device = find(event.data.locus.self.devices, (item) => item.url === this.spark.device.url);\n    if (this.locus && event.data.locus.url === this.locus.url || this.correlationId && this.correlationId === device.correlationId) {\n      this.logger.info(`locus event: ${event.data.eventType}`);\n      this._setLocus(event.data.locus);\n    }\n  },\n\n  _setLocus(incoming) {\n    const current = this.locus;\n    if (!current) {\n      this.locus = incoming;\n      return Promise.resolve();\n    }\n    const action = this.spark.locus.compare(current, incoming);\n\n    switch (action) {\n    case USE_INCOMING:\n      this.locus = incoming;\n      // certain reasons for setting a locus (such as from calling\n      // acknowledge())\n      if (this.device) {\n        this.correlationId = this.device.correlationId;\n      }\n      break;\n    case FETCH:\n      return this.spark.locus.get(current)\n         .then((locus) => this._setLocus(locus));\n    default:\n      // do nothing\n    }\n\n    return Promise.resolve();\n  },\n\n  _changeReceivingMedia(key, value) {\n    return new Promise((resolve) => {\n      this.once(`change:receiving${key === `offerToReceiveAudio` ? `Audio` : `Video`}`, () => resolve());\n      this.media.set(key, value);\n    });\n  },\n\n  /**\n   * The response to a PUT to LOCUS/media may not be fully up-to-dat when we\n   * receive it. This method polls locus until we get a locus with the status\n   * properties we expect (or three errors occur)\n   * @returns {Promise<Types~Locus>}\n   */\n  @retry\n  _fetchExpectedLocus() {\n    return this.spark.locus.get(this.locus)\n      .then((locus) => {\n        const locusAudio = locus.self.status.audioStatus.toLowerCase();\n        const mediaAudio = boolToStatus(this.media.audio, this.media.offerToReceiveAudio);\n        if (locusAudio !== mediaAudio) {\n          this.logger.warn(`expected audio ${locusAudio} (locus) to equal ${mediaAudio} (local media)`);\n          throw new Error(`locus.self.status.audioStatus indicates the received DTO is out of date`);\n        }\n\n        const locusVideo = locus.self.status.videoStatus.toLowerCase();\n        const mediaVideo = boolToStatus(this.media.video, this.media.offerToReceiveVideo);\n        if (locusVideo !== mediaVideo) {\n          this.logger.warn(`expected video ${locusVideo} (locus) to equal ${mediaVideo} (local media)`);\n          throw new Error(`locus.self.status.videoStatus indicates the received DTO is out of date`);\n        }\n\n        return locus;\n      });\n  }\n});\n\nCall.make = function make(attrs, options) {\n  return new Call(attrs, options);\n};\n\nexport default Call;\n"]}